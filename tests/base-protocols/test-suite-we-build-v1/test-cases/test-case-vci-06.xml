<testcase id="tc006" xmlns="http://www.gitb.com/tdl/v1/" xmlns:gitb="http://www.gitb.com/core/v1/"
>
    <metadata>
        <gitb:name>Test Case VCI-006: WE BUILD - Pre-authorized code flow - sdjwt - X509</gitb:name>
        <gitb:version>1.0</gitb:version>
        <gitb:description>Test integration of Wallet with WE BUILD reference implementation.
            Pre-authorized code flow (no transaction code) with x509 signing of the sd-jwt issued
            urn:eu.europa.ec.eudi:pid:1 credential"
            Key differences from authorization code flow:
            Pre-authorized flow: No user authorization step; wallet directly exchanges pre-authorized code for access
            token
            No transaction code this endpoint doesn't require a PIN/transaction code
            Issuer signs the SD-JWT with an x509 certificate and includes x5c in the header
        </gitb:description>
        <!-- See here how we refer to a HTML block that will be added as documentation for the test case. -->
        <gitb:documentation import="/docs/test-case-1.html"/>
    </metadata>
    <actors>
        <!--
            The Actor IDs need to match those in the test suite and in the test engine. One of these needs to always be the SUT (System Under Test).
        -->
        <gitb:actor id="User" role="SUT"/>
        <gitb:actor id="Issuer"/>
    </actors>
    <!-- 
        Setting "stopOnError" to true will stop the test session as soon as an error is encountered. By default test sessions will continue regardless of errors.
    -->
    <steps stopOnError="false">
        <!--
            The "call" step is used to use a scriptlet, which is the GITB TDL's construct for a reusable block of steps.
            Anything that repeats can be defined as a scriptlet and reused like this. You can also parameterise its use
            through the inputs you pass it.
        -->
        <call id="issue" path="/scriptlets/pa-01.xml">
            <input name="credentialType">"urn:eu.europa.ec.eudi:pid:1"</input>
        </call>
    </steps>
    <!-- The output section allows us to define specialised summary error (or success) messages to make the result more user-friendly. -->
    <output>
        <success>
            <default>"Test case completed successfully."</default>
        </success>
        <failure>
            <case>
                <!--
                    Notice how we use the built-in "STEP_STATUS" map to lookup the status of steps by their ID.
                    To check steps defined within scriptlets you prefix the step ID by the scriptlet call step's ID (separated by an underscore).
                -->
                <cond>$STEP_STATUS{authenticate_step1} = 'ERROR'</cond>
                <message>"The credential request was not completed successfully. Please check the failed step's report
                    for more information and the test log."
                </message>
            </case>
            <case>
                <cond>$STEP_STATUS{authenticate_getValidationResponse} = 'ERROR'</cond>
                <message>"A completed validation response was not received within the expected time limit."</message>
            </case>
            <case>
                <cond>$STEP_STATUS{authenticate_step2} = 'ERROR'</cond>
                <message>"The validation response was not completed successfully. Please check the failed step's report
                    for more information and the test log."
                </message>
            </case>
            <!-- If no specific case is matched print a default message. -->
            <default>"Test case failed. Please check the failed step's report for more information and the test log."
            </default>
        </failure>
    </output>
</testcase>